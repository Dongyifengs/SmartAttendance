name: Build and Deploy Static Site

on:
  push:
    branches:
      - main  # 监听 main 分支的更新

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: 检出代码
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 确保可以访问完整的 Git 历史记录

      # Step 2: 设置 Node.js 环境
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18  # 你可以根据项目需求更改 Node.js 版本

      # Step 3: 安装依赖
      - name: Install dependencies
        run: npm install

      # Step 4: 编译 Vite 项目
      - name: Build static site
        run: npm run build  # 确保在 package.json 中配置了 "build" 脚本

      # Step 5: 推送到 static 分支
      - name: Deploy to static branch
        run: |
          # 初始化 Git 仓库
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # 创建一个临时目录用于存储编译后的文件
          BUILD_DIR=dist  # Vite 默认生成目录为 dist
          TARGET_BRANCH=static
          
          # 删除旧的 static 分支内容
          git fetch origin $TARGET_BRANCH
          git switch $TARGET_BRANCH || git checkout --orphan $TARGET_BRANCH
          git rm -rf . || true
          
          # 复制新生成的文件到工作目录
          cp -r $BUILD_DIR/* .
          
          # 添加所有文件并提交
          git add .
          git commit -m "Deploy static site from main: $(date -u +'%Y-%m-%d %H:%M:%S')"
          
          # 强制推送到 static 分支
          git push origin HEAD:$TARGET_BRANCH --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}