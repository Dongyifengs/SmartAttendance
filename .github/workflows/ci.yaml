name: æ„å»ºå¹¶éƒ¨ç½²é™æ€ç«™ç‚¹

on:
  push:
    branches:
      - master  # å½“ master åˆ†æ”¯æœ‰æ¨é€æ—¶è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç ï¼ˆåŒ…æ‹¬ static åˆ†æ”¯ï¼‰
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: static  # ç›´æ¥æ£€å‡º static åˆ†æ”¯

      # æ­¥éª¤ 2: è®¾ç½® Node.js 22 ç¯å¢ƒ
      - name: è®¾ç½® Node.js 22
        uses: actions/setup-node@v3
        with:
          node-version: 22

      # æ­¥éª¤ 3: è·å–æœ€æ–°çš„æäº¤ä¿¡æ¯
      - name: è·å–æäº¤ä¿¡æ¯
        id: commit_info
        run: |
          git fetch origin master
          COMMIT_MESSAGE=$(git log -1 --pretty=%B origin/master)
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          COMMIT_HASH=$(git log -1 --pretty=%H origin/master)
          echo "commit_hash=${COMMIT_HASH:0:7}" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 4: å®‰è£…ä¾èµ–å¹¶æ„å»ºé¡¹ç›®
      - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
        run: |
          npm install
          npm run build

      # æ­¥éª¤ 5: æ¸…ç†æ—§æ–‡ä»¶å¹¶æ·»åŠ æ–°æ–‡ä»¶
      - name: æ›´æ–°é™æ€æ–‡ä»¶
        run: |
          # åˆ é™¤é™¤ .git å¤–çš„æ‰€æœ‰æ–‡ä»¶
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
          # å¤åˆ¶æ–°çš„æ„å»ºæ–‡ä»¶
          cp -r dist/* .
          # æ¸…ç†ä¸å¿…è¦çš„ç›®å½•
          rm -rf dist
          
          git add .
          git status

      # æ­¥éª¤ 6: æäº¤æ›´æ”¹
      - name: æäº¤æ›´æ”¹
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          # å¦‚æœæœ‰å˜æ›´å°±æäº¤
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "ğŸš€ éƒ¨ç½²: ${{ steps.commit_info.outputs.commit_message }} (åŸºäº ${{ steps.commit_info.outputs.commit_hash }})"
          fi

      # æ­¥éª¤ 7: æ¨é€åˆ° static åˆ†æ”¯
      - name: æ¨é€åˆ° static åˆ†æ”¯
        run: git push origin static
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}