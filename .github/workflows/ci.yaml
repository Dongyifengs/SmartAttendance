name: æ„å»ºå¹¶éƒ¨ç½²é™æ€ç«™ç‚¹

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    if: github.repository == 'Dongyifengs/SmartAttendance'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js 22
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: è·å–æäº¤ä¿¡æ¯
        id: commit_info
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%B | tr '\n' ' ' | sed 's/%/%25/g; s/\r/%0D/g; s/\n/%0A/g')
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          COMMIT_HASH=$(git log -1 --pretty=%H)
          echo "commit_hash=${COMMIT_HASH:0:7}" >> $GITHUB_OUTPUT

      - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
        run: |
          npm install
          npm run build

      # âœ… ä¸´æ—¶ä¿å­˜æ„å»ºç»“æœ
      - name: å¤‡ä»½æ„å»ºäº§ç‰©
        run: |
          mkdir ../build-temp
          cp -r dist/* ../build-temp/

      # âœ… åˆ‡æ¢åˆ° static åˆ†æ”¯ï¼ˆä¿ç•™å†å²ï¼‰
      - name: åˆ‡æ¢åˆ° static åˆ†æ”¯
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git fetch origin static:static || echo "static åˆ†æ”¯ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°åˆ†æ”¯"
          git checkout static || git checkout -b static

      # âœ… è¿˜åŸæ„å»ºå†…å®¹ + æäº¤
      - name: æ›´æ–°é™æ€æ–‡ä»¶
        run: |
          rm -rf ./*
          cp -r ../build-temp/* .
          rm -rf ../build-temp
          git add -A
          git commit -m "ğŸš€ éƒ¨ç½²: ${{ steps.commit_info.outputs.commit_message }} (åŸºäº ${{ steps.commit_info.outputs.commit_hash }})" || echo "âš ï¸ æ— æ–‡ä»¶æ›´æ”¹ï¼Œè·³è¿‡æäº¤"

      # âœ… æ¨é€åˆ° static åˆ†æ”¯ï¼ˆä¿ç•™å†å²ï¼‰
      - name: æ¨é€åˆ° static åˆ†æ”¯
        run: |
          git pull origin static --rebase || echo "é¦–æ¬¡éƒ¨ç½²ï¼Œæ— éœ€ rebase"
          git push origin static
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
