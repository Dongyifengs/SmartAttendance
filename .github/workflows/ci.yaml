name: æ„å»ºå¹¶éƒ¨ç½²é™æ€ç«™ç‚¹

on:
  push:
    branches:
      - master  # å½“ master åˆ†æ”¯æœ‰æ¨é€æ—¶è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    if: github.repository == 'Dongyifengs/SmartAttendance'
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: æ£€å‡º master åˆ†æ”¯
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ git å†å²è®°å½•

      # æ­¥éª¤ 2: è®¾ç½® Node.js 22 ç¯å¢ƒ
      - name: è®¾ç½® Node.js 22
        uses: actions/setup-node@v3
        with:
          node-version: 22

      # æ­¥éª¤ 3: è·å–æœ€æ–°çš„æäº¤ä¿¡æ¯
      - name: è·å–æäº¤ä¿¡æ¯
        id: commit_info
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%B | tr '\n' ' ' | sed 's/%/%25/g; s/\r/%0D/g; s/\n/%0A/g')
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          COMMIT_HASH=$(git log -1 --pretty=%H)
          echo "commit_hash=${COMMIT_HASH:0:7}" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 4: å®‰è£…ä¾èµ–å¹¶æ„å»ºé¡¹ç›®
      - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
        run: |
          npm install
          npm run build

      # æ­¥éª¤ 5: åˆ‡æ¢åˆ° static åˆ†æ”¯
      - name: åˆ‡æ¢åˆ° static åˆ†æ”¯
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          if git show-ref --verify --quiet refs/heads/static; then
            git checkout static
          else
            git checkout --orphan static
          fi

      # æ­¥éª¤ 6: å‡†å¤‡é™æ€å†…å®¹
      - name: å‡†å¤‡é™æ€å†…å®¹
        run: |
          git rm -rf .
          cp -r dist/* .
          rm -rf node_modules
          rm -rf dist
          rm -rf *.d.ts
          git add .
          git commit -m "ğŸš€ éƒ¨ç½²: ${{ steps.commit_info.outputs.commit_message }} (åŸºäº ${{ steps.commit_info.outputs.commit_hash }})"

      # æ­¥éª¤ 7: æ¨é€åˆ° static åˆ†æ”¯
      - name: æ¨é€åˆ° static åˆ†æ”¯
        run: git push origin static --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
