name: Build and Deploy Static Site

on:
  push:
    branches:
      - main  # 当 main 分支更新时触发

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: 检出代码
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取完整的 git 历史记录，确保可以创建新分支

      # Step 2: 设置 Node.js 22 环境
      - name: Set up Node.js 22
        uses: actions/setup-node@v3
        with:
          node-version: 22  # 使用 Node.js 22

      # Step 3: 安装依赖并编译代码
      - name: Install dependencies and build
        run: |
          npm install  # 安装依赖
          npm run build  # 使用 Vite 构建静态页面

      # Step 4: 切换到 static 分支（如果不存在则创建）
      - name: Switch to static branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          if git show-ref --verify --quiet refs/heads/static; then
            git checkout static
          else
            git checkout --orphan static
          fi

      # Step 5: 清除旧内容并拷贝新内容
      - name: Prepare static content
        run: |
          git rm -rf .  # 删除 static 分支的旧内容
          cp -r dist/* .  # 将新生成的静态页面拷贝到根目录
          git add .
          git commit -m "Deploy static site from main branch"

      # Step 6: 强制推送到 static 分支
      - name: Push to static branch
        run: git push origin static --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}